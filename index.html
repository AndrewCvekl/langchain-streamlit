<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESONANCE | Music Store Support</title>
    
    <!-- Distinctive Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================
           CSS Variables
           ================== */
        :root {
            /* Color Palette - Sage green and white */
            --bg-primary: #1a2e2e;
            --bg-secondary: #243838;
            --bg-tertiary: #2d4545;
            --bg-card: rgba(45, 69, 69, 0.7);
            
            --accent-primary: #7fa99b;
            --accent-secondary: #a8c5ba;
            --accent-glow: rgba(127, 169, 155, 0.4);
            
            --text-primary: #f5f9f7;
            --text-secondary: #b8ccc4;
            --text-muted: #6b8580;
            
            --border-subtle: rgba(127, 169, 155, 0.15);
            --border-active: rgba(127, 169, 155, 0.4);
            
            --success: #7fa99b;
            --error: #c97b7b;
            --warning: #d4a574;
            
            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Borders */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-glow: 0 0 40px var(--accent-glow);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        /* ==================
           Base Styles
           ================== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* ==================
           Background Effects
           ================== */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
        }
        
        .bg-gradient {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 0%, rgba(127, 169, 155, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(168, 197, 186, 0.06) 0%, transparent 50%),
                linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }
        
        .bg-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(127, 169, 155, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(127, 169, 155, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: gridPulse 8s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }
        
        .bg-noise {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }
        
        /* ==================
           Layout
           ================== */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-lg);
        }
        
        /* ==================
           Header
           ================== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) 0;
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .brand-icon {
            width: 44px;
            height: 44px;
            background: transparent;
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--accent-primary);
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
        }
        
        .brand-name {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--accent-primary);
        }
        
        .brand-tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .customer-badge {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
        }
        
        .customer-avatar {
            width: 24px;
            height: 24px;
            background: transparent;
            border: 2px solid var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .btn-clear {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-clear:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(248, 81, 73, 0.1);
        }
        
        /* ==================
           Chat Container
           ================== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            overflow: hidden;
        }
        
        /* ==================
           Messages Area
           ================== */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-xl) 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            scroll-behavior: smooth;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }
        
        .messages::-webkit-scrollbar {
            width: 12px;
        }
        
        .messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .messages::-webkit-scrollbar-thumb {
            background: rgba(127, 169, 155, 0.15);
            border-radius: 6px;
            border: 3px solid transparent;
            background-clip: padding-box;
        }
        
        .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(127, 169, 155, 0.25);
            background-clip: padding-box;
        }
        
        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: var(--space-2xl) 0;
            animation: fadeIn 0.6s ease;
            width: 100%;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            animation: welcomePulse 2s ease-in-out infinite;
        }
        
        @keyframes welcomePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .welcome-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--accent-primary);
        }
        
        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 1.05rem;
            max-width: 500px;
            margin: 0 auto var(--space-lg);
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--space-sm);
        }
        
        .quick-action {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-action:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(127, 169, 155, 0.1);
        }
        
        /* Message Bubbles */
        .message {
            display: flex;
            gap: var(--space-md);
            width: 100%;
            animation: messageSlide 0.3s ease;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message.assistant {
            flex-direction: row;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
            border: 1.5px solid;
            background: transparent;
            margin-top: 4px;
        }
        
        .message.user .message-avatar {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        
        .message.assistant .message-avatar {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .message-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
            max-width: 100%;
        }
        
        .message-content {
            padding: var(--space-lg) var(--space-xl);
            border-radius: var(--radius-sm);
            line-height: 1.7;
            background: transparent;
        }
        
        .message.user .message-content {
            background: rgba(127, 169, 155, 0.12);
            border: 1px solid rgba(127, 169, 155, 0.25);
        }
        
        .message.assistant .message-content {
            background: rgba(45, 69, 69, 0.5);
            border: 1px solid rgba(127, 169, 155, 0.15);
            margin-bottom: var(--space-lg);
        }
        
        .message.assistant.has-tools .message-content {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-top: none;
            margin-bottom: var(--space-lg);
        }
        
        .message-text {
            font-size: 1.05rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message-text code {
            font-family: var(--font-mono);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        /* Formatted Message Content */
        .message-text strong {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .message-text em {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .message-text a {
            color: var(--accent-secondary);
            text-decoration: none;
            border-bottom: 1px solid var(--accent-glow);
            transition: all 0.2s ease;
        }
        
        .message-text a:hover {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        
        /* Track Cards */
        .track-card {
            background: linear-gradient(135deg, rgba(127, 169, 155, 0.08) 0%, rgba(0, 0, 0, 0.3) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin: var(--space-md) 0;
            transition: all 0.2s ease;
        }
        
        .track-card:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        
        .track-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .track-card-number {
            width: 28px;
            height: 28px;
            background: transparent;
            border: 2px solid var(--accent-primary);
            color: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .track-card-title {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }
        
        .track-card-artist {
            color: var(--accent-secondary);
            font-size: 0.9rem;
        }
        
        .track-card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-xs) var(--space-md);
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--border-subtle);
            font-size: 0.85rem;
        }
        
        .track-card-detail {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--text-secondary);
        }
        
        .track-card-detail-label {
            color: var(--text-muted);
        }
        
        .track-card-detail-value {
            color: var(--text-primary);
            font-family: var(--font-mono);
        }
        
        .track-card-price {
            color: var(--success) !important;
            font-weight: 600;
        }
        
        /* Formatted Lists */
        .formatted-list {
            list-style: none;
            padding: 0;
            margin: var(--space-sm) 0;
        }
        
        .formatted-list li {
            position: relative;
            padding-left: var(--space-lg);
            margin-bottom: var(--space-xs);
            line-height: 1.6;
        }
        
        .formatted-list li::before {
            content: '‚Ä∫';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: bold;
        }
        
        .formatted-list.numbered li {
            counter-increment: list-counter;
        }
        
        .formatted-list.numbered li::before {
            content: counter(list-counter) '.';
            color: var(--accent-primary);
            font-family: var(--font-mono);
            font-size: 0.85em;
        }
        
        /* Tool Calls Accordion */
        .tool-calls {
            width: 100%;
            margin-bottom: 0;
        }
        
        .tool-accordion {
            border: 1px solid #152b21;
            border-bottom: none;
            border-top-left-radius: var(--radius-sm);
            border-top-right-radius: var(--radius-sm);
            overflow: hidden;
            background: #0d1f19;
        }
        
        .tool-accordion-header {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 1px 10px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: #5a9d7a;
            background: #0d1f19;
            transition: all 0.2s ease;
            user-select: none;
            line-height: 1.1;
            min-height: 18px;
        }
        
        .tool-accordion-header:hover {
            background: #152b21;
            color: #6bb88f;
        }
        
        .tool-accordion-icon {
            color: #5a9d7a;
            transition: transform 0.2s ease;
            font-size: 0.6rem;
        }
        
        .tool-accordion.open .tool-accordion-icon {
            transform: rotate(90deg);
        }
        
        .tool-accordion-chevron {
            margin-left: auto;
            font-size: 0.5rem;
            transition: transform 0.2s ease;
        }
        
        .tool-accordion.open .tool-accordion-chevron {
            transform: rotate(180deg);
        }
        
        .tool-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .tool-accordion.open .tool-accordion-content {
            max-height: 500px;
        }
        
        .tool-call {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 1px 10px;
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: #5a9d7a;
            background: #0d1f19;
            border-top: 1px solid #152b21;
            line-height: 1.1;
            min-height: 18px;
        }
        
        .tool-call-icon {
            color: #5a9d7a;
            font-size: 0.6rem;
        }
        
        .tool-call-name {
            color: #5a9d7a;
        }
        
        /* ==================
           Approval Modal
           ================== */
        .approval-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .approval-overlay.active {
            display: flex;
        }
        
        .approval-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-active);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 480px;
            width: 90%;
            box-shadow: var(--shadow-glow), var(--shadow-card);
            animation: modalSlide 0.3s ease;
        }
        
        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .approval-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .approval-icon {
            width: 48px;
            height: 48px;
            background: transparent;
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--accent-primary);
            animation: approvalPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes approvalPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(127, 169, 155, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(127, 169, 155, 0); }
        }
        
        .approval-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .approval-subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .approval-details {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .approval-detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9rem;
        }
        
        .approval-detail-row:last-child {
            border-bottom: none;
        }
        
        .approval-detail-label {
            color: var(--text-secondary);
        }
        
        .approval-detail-value {
            font-family: var(--font-mono);
            color: var(--accent-primary);
        }
        
        .approval-actions {
            display: flex;
            gap: var(--space-md);
        }
        
        .btn-approve, .btn-reject {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-approve {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-approve:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }
        
        .btn-reject {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        
        .btn-reject:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(248, 81, 73, 0.1);
        }
        
        /* ==================
           Input Area
           ================== */
        .input-area {
            padding: var(--space-lg) 0;
            border-top: 1px solid var(--border-subtle);
            background: transparent;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }
        
        .input-wrapper {
            display: flex;
            gap: var(--space-md);
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            position: relative;
        }
        
        .input-field textarea {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 1.05rem;
            resize: none;
            outline: none;
            transition: all 0.2s ease;
            min-height: 52px;
            max-height: 150px;
        }
        
        .input-field textarea::placeholder {
            color: var(--text-muted);
        }
        
        .input-field textarea:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .btn-send {
            width: 52px;
            height: 52px;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-send:hover:not(:disabled) {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }
        
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Loading Indicator */
        .loading-indicator {
            display: none;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
        }
        
        .loading-indicator.active {
            display: flex;
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: loadingBounce 1.4s ease-in-out infinite;
        }
        
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes loadingBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .loading-text {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        /* ==================
           YouTube Embed - Video Player Style
           ================== */
        .youtube-embed {
            margin-top: var(--space-xl);
            margin-bottom: var(--space-xl);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #000;
            border: 2px solid var(--accent-primary);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(127, 169, 155, 0.15);
            position: relative;
        }
        
        .youtube-embed iframe {
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
            display: block;
            border-radius: var(--radius-lg);
        }
        
        /* ==================
           Verification Badge
           ================== */
        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 2px 8px;
            background: rgba(63, 185, 80, 0.2);
            border: 1px solid rgba(63, 185, 80, 0.4);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            color: var(--success);
            margin-left: var(--space-sm);
        }
        
        .verification-badge.unverified {
            background: rgba(139, 148, 158, 0.2);
            border-color: rgba(139, 148, 158, 0.4);
            color: var(--text-muted);
        }
        
        /* ==================
           Responsive
           ================== */
        @media (max-width: 640px) {
            .app-container {
                padding: var(--space-md);
            }
            
            .header {
                flex-wrap: wrap;
                gap: var(--space-md);
            }
            
            .customer-badge {
                display: none;
            }
            
            .message {
                max-width: 95%;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .approval-modal {
                margin: var(--space-md);
            }
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="bg-canvas">
        <div class="bg-gradient"></div>
        <div class="bg-grid"></div>
        <div class="bg-noise"></div>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <div class="brand-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18V5l12-2v13"></path>
                        <circle cx="6" cy="18" r="3"></circle>
                        <circle cx="18" cy="16" r="3"></circle>
                    </svg>
                </div>
                <div class="brand-text">
                    <span class="brand-name">Music Store</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-clear" onclick="clearChat()">
                    <span>‚ü≥</span> Clear
                </button>
            </div>
        </header>
        
        <!-- Chat Container -->
        <main class="chat-container">
            <!-- Messages Area -->
            <div class="messages" id="messagesContainer">
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-primary);">
                            <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                            <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
                        </svg>
                    </div>
                    <h2 class="welcome-title" id="welcomeTitle">Welcome</h2>
                    <p class="welcome-subtitle">
                        I'm here to help you discover music, manage your account, and make purchases. What can I assist you with today?
                    </p>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="sendQuickAction('Show my account details')">My Account</button>
                        <button class="quick-action" onclick="sendFindSong()">Find Song</button>
                        <button class="quick-action" onclick="sendQuickAction('Show me my recent purchases')">View Purchase History</button>
                    </div>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div class="loading-indicator" id="loadingIndicator">
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
                <span class="loading-text">Thinking...</span>
            </div>
            
            <!-- Input Area -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-field">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ask about music, your account, or purchases..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    <button class="btn-send" id="sendButton" onclick="sendMessage()">
                        ‚Üí
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Approval Modal -->
    <div class="approval-overlay" id="approvalOverlay">
        <div class="approval-modal">
            <div class="approval-header">
                <div class="approval-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div>
                    <div class="approval-title">Approval Required</div>
                    <div class="approval-subtitle">This action requires your confirmation</div>
                </div>
            </div>
            <div class="approval-details" id="approvalDetails">
                <!-- Dynamic content -->
            </div>
            <div class="approval-actions">
                <button class="btn-reject" onclick="handleApproval(false)">Cancel</button>
                <button class="btn-approve" onclick="handleApproval(true)">Approve</button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================
        // State
        // ==================
        const state = {
            sessionId: 'session_' + Math.random().toString(36).substr(2, 9),
            messages: [],
            isLoading: false,
            pendingInterrupt: null,
            isVerified: false,
            customer: null,
        };
        
        // ==================
        // DOM Elements
        // ==================
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const approvalOverlay = document.getElementById('approvalOverlay');
        const approvalDetails = document.getElementById('approvalDetails');
        const welcomeTitle = document.getElementById('welcomeTitle');
        
        // ==================
        // Initialization
        // ==================
        async function init() {
            try {
                const response = await fetch('/api/customer');
                state.customer = await response.json();
                
                if (state.customer && welcomeTitle) {
                    welcomeTitle.textContent = `Welcome ${state.customer.name}`;
                }
            } catch (error) {
                console.error('Failed to load customer info:', error);
            }
        }
        
        init();
        
        // ==================
        // Message Handling
        // ==================
        function renderMessages() {
            // Clear existing messages except welcome
            const existingMessages = messagesContainer.querySelectorAll('.message');
            existingMessages.forEach(m => m.remove());
            
            // Hide welcome if there are messages
            if (state.messages.length > 0) {
                welcomeMessage.style.display = 'none';
            } else {
                welcomeMessage.style.display = 'block';
            }
            
            // Aggregate tool calls from consecutive assistant messages
            const aggregatedMessages = [];
            let currentGroup = null;
            
            state.messages.forEach(msg => {
                if (msg.role === 'assistant' && msg.tool_calls && msg.tool_calls.length > 0) {
                    // If we have a current group, add to it
                    if (currentGroup && currentGroup.role === 'assistant') {
                        currentGroup.tool_calls.push(...msg.tool_calls);
                        // Only update content if this message has actual content
                        if (msg.content && msg.content.trim()) {
                            currentGroup.content = msg.content;
                        }
                    } else {
                        // Start a new group
                        currentGroup = {
                            role: 'assistant',
                            content: msg.content || '',
                            tool_calls: [...msg.tool_calls]
                        };
                        aggregatedMessages.push(currentGroup);
                    }
                } else {
                    // Regular message or user message
                    currentGroup = null;
                    aggregatedMessages.push(msg);
                }
            });
            
            // Render aggregated messages
            aggregatedMessages.forEach(msg => {
                const messageEl = createMessageElement(msg);
                messagesContainer.appendChild(messageEl);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = `message ${msg.role}`;
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = msg.role === 'user' 
                ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'
                : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>';
            
            // Wrapper for content and tools
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            
            // Add tool calls BEFORE message content if present
            if (msg.tool_calls && msg.tool_calls.length > 0) {
                div.classList.add('has-tools');
                
                const toolsDiv = document.createElement('div');
                toolsDiv.className = 'tool-calls';
                
                const toolCount = msg.tool_calls.length;
                
                toolsDiv.innerHTML = `
                    <div class="tool-accordion">
                        <div class="tool-accordion-header" onclick="toggleToolAccordion(this)">
                            <span class="tool-accordion-icon">‚ö°</span>
                            <span>${toolCount} tool${toolCount > 1 ? 's' : ''} used</span>
                            <span class="tool-accordion-chevron">‚ñº</span>
                        </div>
                        <div class="tool-accordion-content">
                            ${msg.tool_calls.map(tc => `
                                <div class="tool-call">
                                    <span class="tool-call-icon">‚Ä∫</span>
                                    <span class="tool-call-name">${escapeHtml(tc.name)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                wrapper.appendChild(toolsDiv);
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            // Check for YouTube embed
            const youtubeMatch = msg.content.match(/YOUTUBE_VIDEO\|([^|]+)\|([^|]+)\|([^|]+)/);
            if (youtubeMatch) {
                const [_, videoId, videoTitle, channelTitle] = youtubeMatch;
                const textBefore = msg.content.split('YOUTUBE_VIDEO|')[0].trim();
                
                if (textBefore) {
                    const textEl = document.createElement('div');
                    textEl.className = 'message-text';
                    textEl.textContent = textBefore;
                    content.appendChild(textEl);
                }
                
                const embedEl = document.createElement('div');
                embedEl.className = 'youtube-embed';
                embedEl.innerHTML = `
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0&modestbranding=1&controls=1"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                    ></iframe>
                `;
                content.appendChild(embedEl);
            } else {
                const text = document.createElement('div');
                text.className = 'message-text';
                text.innerHTML = formatMessageContent(msg.content);
                content.appendChild(text);
            }
            
            wrapper.appendChild(content);
            div.appendChild(avatar);
            div.appendChild(wrapper);
            
            return div;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================
        // Message Formatting
        // ==================
        
        function formatMarkdown(text) {
            if (!text) return '';
            
            let html = escapeHtml(text);
            
            // Bold: **text** or __text__
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // Italic: *text* or _text_
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // Inline code: `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert line breaks
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }
        
        function parseTrackListing(text) {
            // Detect track listings like:
            // 1. **"Song Name"** by Artist
            //    - Album: ...
            //    - Duration: ...
            //    - Price: $0.99
            
            const trackPattern = /(\d+)\.\s*\*?\*?"?([^"*\n]+)"?\*?\*?\s*by\s+([^\n]+)\n((?:\s*-\s*[^\n]+\n?)+)/gi;
            const tracks = [];
            let match;
            
            while ((match = trackPattern.exec(text)) !== null) {
                const [fullMatch, number, title, artist, detailsBlock] = match;
                const details = {};
                
                // Parse details like "- Album: ..." or "- Price: $0.99"
                const detailLines = detailsBlock.split('\n');
                detailLines.forEach(line => {
                    const detailMatch = line.match(/-\s*([^:]+):\s*(.+)/);
                    if (detailMatch) {
                        details[detailMatch[1].trim().toLowerCase()] = detailMatch[2].trim();
                    }
                });
                
                tracks.push({
                    number: parseInt(number),
                    title: title.trim().replace(/^["']|["']$/g, ''),
                    artist: artist.trim(),
                    details
                });
            }
            
            return tracks;
        }
        
        function createTrackCardsHtml(tracks) {
            return tracks.map(track => `
                <div class="track-card">
                    <div class="track-card-header">
                        <span class="track-card-number">${track.number}</span>
                        <span class="track-card-title">${escapeHtml(track.title)}</span>
                        <span class="track-card-artist">by ${escapeHtml(track.artist)}</span>
                    </div>
                    <div class="track-card-details">
                        ${track.details.album ? `<div class="track-card-detail"><span class="track-card-detail-label">üíø</span><span class="track-card-detail-value">${escapeHtml(track.details.album)}</span></div>` : ''}
                        ${track.details.duration ? `<div class="track-card-detail"><span class="track-card-detail-label">‚è±Ô∏è</span><span class="track-card-detail-value">${escapeHtml(track.details.duration)}</span></div>` : ''}
                        ${track.details.price ? `<div class="track-card-detail"><span class="track-card-detail-label">üí∞</span><span class="track-card-detail-value track-card-price">${escapeHtml(track.details.price)}</span></div>` : ''}
                        ${track.details.genre ? `<div class="track-card-detail"><span class="track-card-detail-label">üé∏</span><span class="track-card-detail-value">${escapeHtml(track.details.genre)}</span></div>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function detectYouTubeFromMarkdown(text) {
            // Detect markdown image links to YouTube: [![...](img)](video_url)
            // or direct YouTube URLs
            const patterns = [
                /\[!\[[^\]]*\]\([^)]*youtube[^)]*\)\]\(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)[^)]*\)/i,
                /\[!\[[^\]]*\]\([^)]*\)\]\(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)[^)]*\)/i,
                /https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/i,
                /https?:\/\/youtu\.be\/([a-zA-Z0-9_-]+)/i,
                /YOUTUBE_VIDEO\|([a-zA-Z0-9_-]+)\|([^|]+)\|([^|\n]+)/
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    // Extract video ID and try to get title from context
                    const videoId = match[1];
                    let title = match[2] || '';
                    let channel = match[3] || '';
                    
                    // Try to extract title from surrounding text
                    if (!title) {
                        const titleMatch = text.match(/\*\*"?([^"*]+)"?\*\*/);
                        if (titleMatch) title = titleMatch[1];
                    }
                    
                    return { videoId, title, channel };
                }
            }
            return null;
        }
        
        function createYouTubeEmbedHtml(video) {
            return `
                <div class="youtube-embed">
                    <iframe 
                        src="https://www.youtube.com/embed/${video.videoId}?autoplay=1&mute=1&rel=0&modestbranding=1&controls=1"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                    ></iframe>
                </div>
            `;
        }
        
        function formatMessageContent(text) {
            if (!text) return '';
            
            // Check for YOUTUBE_VIDEO pattern first (from tool)
            const youtubeToolMatch = text.match(/YOUTUBE_VIDEO\|([^|]+)\|([^|]+)\|([^|\n]+)/);
            if (youtubeToolMatch) {
                const [fullMatch, videoId, title, channel] = youtubeToolMatch;
                const textBefore = text.split('YOUTUBE_VIDEO|')[0].trim();
                const textAfter = text.split(fullMatch)[1]?.trim() || '';
                
                let html = '';
                if (textBefore) html += formatMarkdown(textBefore);
                html += createYouTubeEmbedHtml({ videoId, title, channel });
                if (textAfter) html += formatMarkdown(textAfter);
                return html;
            }
            
            // Check for YouTube markdown links
            const youtubeFromMarkdown = detectYouTubeFromMarkdown(text);
            if (youtubeFromMarkdown) {
                // Remove the markdown link and add embed
                let cleanText = text
                    .replace(/\[!\[[^\]]*\]\([^)]*\)\]\([^)]*\)/g, '')
                    .replace(/You can click the image above[^\n]*/gi, '')
                    .replace(/You can watch it on \[YouTube\]\([^)]*\)[^\n]*/gi, '')
                    .replace(/Enjoy!/gi, '')
                    .trim();
                
                let html = '';
                if (cleanText) html += `<p>${formatMarkdown(cleanText)}</p>`;
                html += createYouTubeEmbedHtml(youtubeFromMarkdown);
                return html;
            }
            
            // Check for track listings
            const tracks = parseTrackListing(text);
            if (tracks.length > 0) {
                // Find text before first track
                const firstTrackIndex = text.search(/\d+\.\s*\*?\*?"?[^"*\n]+"?\*?\*?\s*by/i);
                const textBefore = firstTrackIndex > 0 ? text.substring(0, firstTrackIndex).trim() : '';
                
                let html = '';
                if (textBefore) html += `<p>${formatMarkdown(textBefore)}</p>`;
                html += createTrackCardsHtml(tracks);
                return html;
            }
            
            // Default: just format markdown
            return formatMarkdown(text);
        }
        
        function toggleToolAccordion(el) {
            el.closest('.tool-accordion').classList.toggle('open');
        }
        
        // ==================
        // API Calls
        // ==================
        async function sendMessage(customMessage = null) {
            const message = customMessage || messageInput.value.trim();
            if (!message || state.isLoading) return;
            
            // Clear input
            if (!customMessage) {
                messageInput.value = '';
                autoResize(messageInput);
            }
            
            // Add user message immediately
            state.messages.push({ role: 'user', content: message });
            renderMessages();
            
            // Show loading
            setLoading(true);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: state.sessionId,
                    }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send message');
                }
                
                const data = await response.json();
                
                // Update state
                state.messages = data.messages;
                state.isVerified = data.is_verified;
                state.pendingInterrupt = data.pending_interrupt;
                
                // Render messages
                renderMessages();
                
                // Show approval modal if needed
                if (data.pending_interrupt) {
                    showApprovalModal(data.pending_interrupt);
                }
                
            } catch (error) {
                console.error('Error:', error);
                state.messages.push({
                    role: 'assistant',
                    content: '‚ùå Sorry, something went wrong. Please try again.',
                });
                renderMessages();
            } finally {
                setLoading(false);
            }
        }
        
        async function handleApproval(approved) {
            hideApprovalModal();
            setLoading(true);
            
            try {
                const response = await fetch('/api/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: state.sessionId,
                        approved: approved,
                    }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process approval');
                }
                
                const data = await response.json();
                
                // Update state
                state.messages = data.messages;
                state.isVerified = data.is_verified;
                state.pendingInterrupt = data.pending_interrupt;
                
                // Render messages
                renderMessages();
                
                // Show another approval modal if needed
                if (data.pending_interrupt) {
                    showApprovalModal(data.pending_interrupt);
                }
                
            } catch (error) {
                console.error('Error:', error);
                state.messages.push({
                    role: 'assistant',
                    content: '‚ùå Sorry, something went wrong processing your response.',
                });
                renderMessages();
            } finally {
                setLoading(false);
            }
        }
        
        async function clearChat() {
            try {
                await fetch(`/api/clear?session_id=${state.sessionId}`, {
                    method: 'POST',
                });
                
                state.messages = [];
                state.pendingInterrupt = null;
                state.sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
                
                renderMessages();
            } catch (error) {
                console.error('Error clearing chat:', error);
            }
        }
        
        // ==================
        // UI Helpers
        // ==================
        function setLoading(loading) {
            state.isLoading = loading;
            loadingIndicator.classList.toggle('active', loading);
            sendButton.disabled = loading;
            messageInput.disabled = loading;
        }
        
        function showApprovalModal(interrupt) {
            let detailsHtml = '';
            
            if (interrupt.track_name) {
                // Purchase approval
                detailsHtml = `
                    <div class="approval-detail-row">
                        <span class="approval-detail-label">Action</span>
                        <span class="approval-detail-value">üí∞ Purchase Track</span>
                    </div>
                    <div class="approval-detail-row">
                        <span class="approval-detail-label">Track</span>
                        <span class="approval-detail-value">${escapeHtml(interrupt.track_name)}</span>
                    </div>
                    <div class="approval-detail-row">
                        <span class="approval-detail-label">Track ID</span>
                        <span class="approval-detail-value">#${interrupt.track_id || 'N/A'}</span>
                    </div>
                    <div class="approval-detail-row">
                        <span class="approval-detail-label">Price</span>
                        <span class="approval-detail-value">$${(interrupt.track_price || 0).toFixed(2)}</span>
                    </div>
                `;
            } else if (interrupt.tool_calls) {
                // Generic tool approval
                const tc = interrupt.tool_calls[0];
                const toolName = tc?.name || 'Unknown';
                const args = tc?.args || {};
                
                detailsHtml = `
                    <div class="approval-detail-row">
                        <span class="approval-detail-label">Action</span>
                        <span class="approval-detail-value">‚ö° ${escapeHtml(toolName)}</span>
                    </div>
                `;
                
                for (const [key, value] of Object.entries(args)) {
                    detailsHtml += `
                        <div class="approval-detail-row">
                            <span class="approval-detail-label">${escapeHtml(key)}</span>
                            <span class="approval-detail-value">${escapeHtml(String(value))}</span>
                        </div>
                    `;
                }
            } else {
                detailsHtml = `
                    <div class="approval-detail-row">
                        <span class="approval-detail-label">Message</span>
                        <span class="approval-detail-value">${escapeHtml(interrupt.message || 'Approval required')}</span>
                    </div>
                `;
            }
            
            approvalDetails.innerHTML = detailsHtml;
            approvalOverlay.classList.add('active');
        }
        
        function hideApprovalModal() {
            approvalOverlay.classList.remove('active');
        }
        
        function sendQuickAction(message) {
            sendMessage(message);
        }
        
        function sendFindSong() {
            const lyrics = prompt('Enter the lyrics you remember:');
            if (lyrics && lyrics.trim()) {
                sendMessage(`I heard this song on the radio it goes like: '${lyrics.trim()}'`);
            }
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
        
        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && approvalOverlay.classList.contains('active')) {
                handleApproval(false);
            }
        });
        
        // Close modal on overlay click
        approvalOverlay.addEventListener('click', (e) => {
            if (e.target === approvalOverlay) {
                handleApproval(false);
            }
        });
    </script>
</body>
</html>
